<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Olhar Urbano - Observe. Registre. Impacte.</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        :root { --primary: #10b981; --primary-hover: #059669; --bg: #f9fafb; --card: #ffffff; --accent: #2d5af7; }
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: var(--bg); margin: 0; color: #1f2937; }
        
        /* Tab Navigation */
        .nav-tabs { display: flex; background: #fff; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #e5e7eb; }
        .tab { flex: 1; padding: 16px; text-align: center; font-size: 0.85rem; font-weight: 700; color: #6b7280; cursor: pointer; transition: 0.3s; text-transform: uppercase; letter-spacing: 0.5px; }
        .tab.active { color: var(--accent); border-bottom: 3px solid var(--accent); }

        /* Container Centralizado */
        .view { display: none; padding: 20px; max-width: 450px; margin: 0 auto; box-sizing: border-box; }
        .view.active { display: block; animation: slideUp 0.4s ease-out; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Branding */
        .branding { text-align: center; padding: 20px 0; }
        .branding h1 { margin: 0; font-size: 1.6rem; color: #111827; font-weight: 800; }
        .branding p { margin: 5px 0 0; font-size: 0.85rem; color: #6b7280; }

        /* Cards */
        .card { background: var(--card); border-radius: 20px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid #f3f4f6; }
        .label-group { font-size: 0.7rem; font-weight: 800; color: #9ca3af; text-transform: uppercase; margin-bottom: 12px; display: block; }

        select, input { 
            width: 100%; border: 1px solid #e5e7eb; background: #fcfcfd; padding: 14px; border-radius: 12px; 
            font-size: 1rem; color: #374151; box-sizing: border-box;
        }

        /* Botão Verde com Brilho */
        .btn-impact { 
            width: 100%; background: var(--primary); color: white; border: none; padding: 20px; 
            border-radius: 18px; font-weight: 800; font-size: 1.1rem; cursor: pointer; 
            transition: all 0.3s; box-shadow: 0 4px 14px rgba(16, 185, 129, 0.4);
            position: relative; overflow: hidden;
        }
        .btn-impact:hover { background: var(--primary-hover); transform: translateY(-2px); }
        .btn-impact::after {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg); animation: shine 3s infinite;
        }
        @keyframes shine { 0% { left: -100%; } 100% { left: 100%; } }

        /* Dashboard */
        #map { width: 100%; height: 50vh; border-radius: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stat-card { background: white; padding: 15px; border-radius: 18px; text-align: center; border: 1px solid #eee; }
        .stat-card b { font-size: 1.5rem; color: var(--accent); display: block; }
    </style>
</head>
<body>

<nav class="nav-tabs">
    <div class="tab active" onclick="switchTab('user')">Observar</div>
    <div class="tab" onclick="switchTab('dash')">Impacto</div>
</nav>

<div id="user-view" class="view active">
    <div class="branding">
        <h1>Olhar Urbano</h1>
        <p>Observe. Registre. Impacte.</p>
    </div>

    <div class="card">
        <span class="label-group">1. Volume</span>
        <label style="font-size: 0.9rem; margin-bottom: 8px; display: block;">Quantas pessoas identificadas?</label>
        <input type="number" id="qtd" placeholder="Ex: 1" inputmode="numeric">
    </div>

    <div class="card">
        <span class="label-group">2. Perfil</span>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div>
                <label style="font-size: 0.75rem; font-weight: bold;">Sexo</label>
                <select id="sexo">
                    <option value="" selected disabled>Escolha</option>
                    <option value="Masculino">Masculino</option>
                    <option value="Feminino">Feminino</option>
                    <option value="Outro">Outro</option>
                </select>
            </div>
            <div>
                <label style="font-size: 0.75rem; font-weight: bold;">Idade</label>
                <select id="faixa">
                    <option value="" selected disabled>Escolha</option>
                    <option value="Criança">Criança</option>
                    <option value="Adolescente">Adolescente</option>
                    <option value="Adulto">Adulto</option>
                    <option value="Idoso">Idoso</option>
                </select>
            </div>
        </div>
    </div>

    <div class="card">
        <span class="label-group">3. Contexto</span>
        <div style="margin-bottom: 15px;">
            <select id="situacao">
                <option value="" selected disabled>Situação de Rua?</option>
                <option value="Sim">Sim, reside no local</option>
                <option value="Não">Não</option>
                <option value="Passagem">Em trânsito</option>
            </select>
        </div>
        <select id="drogas">
            <option value="" selected disabled>Uso de Drogas?</option>
            <option value="Sim">Sim</option>
            <option value="Não">Não</option>
        </select>
    </div>

    <button class="btn-impact" id="btn-save" onclick="registrar()">REGISTRAR AGORA</button>
</div>

<div id="dash-view" class="view">
    <div class="branding">
        <h1>Mapa Coletivo</h1>
        <p>Registros de todos os observadores</p>
    </div>
    <div id="map"></div>
    <div class="stats">
        <div class="stat-card"><small>OCORRÊNCIAS</small><b id="st-reg">0</b></div>
        <div class="stat-card"><small>TOTAL PESSOAS</small><b id="st-pes">0</b></div>
    </div>
</div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAyeljGisp0yk242H4s3VC_xFeBwESDrjU&libraries=visualization"></script>

<script>
    // CONFIGURAÇÃO DO SEU FIREBASE
    const firebaseConfig = {
        apiKey: "AIzaSyCv33-vr99tYWdxdeJP4rsp39ro5M2gZNo",
        authDomain: "olhar-urbano.firebaseapp.com",
        databaseURL: "https://olhar-urbano-default-rtdb.firebaseio.com",
        projectId: "olhar-urbano",
        storageBucket: "olhar-urbano.firebasestorage.app",
        messagingSenderId: "728837322622",
        appId: "1:728837322622:web:06765d7f0449b0b9caa52f"
    };

    firebase.initializeApp(firebaseConfig);
    const dbCloud = firebase.database();

    let geo = { lat: null, lng: null };
    let registrosGlobais = [];

    navigator.geolocation.watchPosition(p => {
        geo.lat = p.coords.latitude;
        geo.lng = p.coords.longitude;
    }, null, { enableHighAccuracy: true });

    function switchTab(type) {
        document.querySelectorAll('.tab, .view').forEach(el => el.classList.remove('active'));
        if(type === 'user') {
            document.querySelectorAll('.tab')[0].classList.add('active');
            document.getElementById('user-view').classList.add('active');
        } else {
            document.querySelectorAll('.tab')[1].classList.add('active');
            document.getElementById('dash-view').classList.add('active');
            setTimeout(initMap, 200);
        }
    }

    function registrar() {
        const fields = ['qtd', 'sexo', 'faixa', 'situacao', 'drogas'];
        const data = {};
        for(let f of fields) {
            data[f] = document.getElementById(f).value;
            if(!data[f]) return alert("Preencha todos os campos!");
        }

        if(!geo.lat) return alert("Buscando sua localização...");

        const btn = document.getElementById('btn-save');
        btn.disabled = true;
        btn.innerText = "ENVIANDO À NUVEM...";

        const item = { ...data, lat: geo.lat, lng: geo.lng, qtd: parseInt(data.qtd), ts: Date.now() };

        // SALVANDO NO FIREBASE (NUVEM)
        dbCloud.ref('ocorrencias').push(item)
            .then(() => {
                alert("Obrigado por Colaborar!");
                fields.forEach(f => document.getElementById(f).value = "");
                btn.disabled = false;
                btn.innerText = "REGISTRAR AGORA";
            })
            .catch(err => {
                alert("Erro ao salvar: " + err.message);
                btn.disabled = false;
            });
    }

    function initMap() {
        // ESCUTANDO DADOS DA NUVEM EM TEMPO REAL
        dbCloud.ref('ocorrencias').on('value', (snapshot) => {
            const data = snapshot.val();
            registrosGlobais = data ? Object.values(data) : [];
            
            const center = (registrosGlobais.length > 0) ? 
                {lat: registrosGlobais[registrosGlobais.length-1].lat, lng: registrosGlobais[registrosGlobais.length-1].lng} : 
                {lat: -23.55, lng: -46.63};

            const map = new google.maps.Map(document.getElementById("map"), {
                zoom: 13, center: center, disableDefaultUI: true
            });

            const points = registrosGlobais.map(p => ({ 
                location: new google.maps.LatLng(p.lat, p.lng), 
                weight: p.qtd 
            }));

            new google.maps.visualization.HeatmapLayer({ 
                data: points, map: map, radius: 40,
                gradient: ['transparent', '#10b981', '#fbbf24', '#ef4444']
            });

            document.getElementById('st-reg').innerText = registrosGlobais.length;
            document.getElementById('st-pes').innerText = registrosGlobais.reduce((a, b) => a + (b.qtd || 0), 0);
        });
    }
</script>
</body>
</html>